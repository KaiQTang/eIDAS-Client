# Funktsionaalsed nõuded

<a name="autentimisvastus"></a>
## Üldised autentimisvastuse kontrollid

| ID   | Lühikirjeldus | Nõue |
|:----:|:--------------|:-----|
| AV-1 | Kohustuslike parameetrite olemasolu kontroll | Kontrollima peab kõigi kohustuslike parameetrite olemasolu vastavalt [**API kirjeldusele**](Service-API.md#returnUrl). Vastasel juhul tuleb tagastada viga **400 Bad Request**.|
| AV-2 | Kõigi parameetrite lubatud väärtuste kontroll | Kontrollima peab kõigi parameetrite väärtust vastavalt [**API kirjelduses**](Service-API.md#returnUrl) toodud kitsendustele. Vastasel juhul tuleb tagastada viga **400 Bad Request**.|
| AV-3 | SAML vastuse XML skeemi kontroll | Enne mistahes sisukontrolle peab SAMLResponse sisu vastavust kontrollima SAML2 core, ja eIDAS XML skeemide vastu. Juhul kui SAMLResponse sisu ei vasta skeemile, tuleb tagastada viga **400 Bad Request**. Detailsem veakirjeldus toodud [**API kirjelduses**](Service-API.md#veakasitlus).|
| AV-4 | SAML vastus on alati allkirjastatud | Sissetuleva SAML Response peab olema allkirjastatud. Juhul kui ei ole, tagastatakse viga **400 Bad Request**. |
| AV-5 | SAML vastuse allkirja kontroll | Sissetuleva SAML Response allkirja peab valideerima kasutades selleks konnektorteenuse metadatas toodud allkirjastamise serti (mitte vastuses olevat serti). Kui allkiri ei valideeru, peab tagastama vea **400 Bad Request**. |
| AV-6 | SAML vastuse staatuse kontroll | SAML sõnumi edasine töötlemine tuleb katkestada juhul, kui SAML vastuses esimese taseme staatuskood ei ole **urn:oasis:names:tc:SAML:2.0:status:Success**. <p>Kasutajale tagastatakse viga **401 Unauthorized** juhul kui teise taseme staatuskood on üks alljärgnevatest staatuskoodidest. <ul><li>**urn:oasis:names:tc:SAML:2.0:status:AuthnFailed**  (autentimine ebaõnnestus)</li><li>**urn:oasis:names:tc:SAML:2.0:status:RequestDenied** (kasutaja ei andnud isikuandmete avaldamiseks nõusolekut)</li></ul></p><p>Kõigi muude veakoodide puhul tagastatakse **HTTP 500 Internal Server Error** ning statusCode ja statusMessage logitakse vea tasemel. </p>  |
| AV-7 | SAML vastuse väljastamise aja kontroll |  SAML vastuse väljastamiseg (`/saml2p:Response/@IssueInstant`) ei tohi olla aegunud ega tulevikus. Väljastamisaeg peab jääma vahemikku, mille alguseks on `/saml2p:Response/@IssueInstant` - lubatud interval - lubatud kella erinevus ja `/saml2p:Response/@IssueInstant` + lubatud intervall + lubatud kella erinevus. Vastasel juhul peab tagastama vea **400 Bad Request**. |
| AV-8 | SAML vastusega seotud kehtiva päringu kontroll | Sissetuleva SAML Response `InResponseTo` atribuudi sisu peab viitama sõnumite vastavustabelis olevale kehtivale ja töötlemata päringule. Vastasel juhul peab tagastama vea **400 Bad Request**. |
| AV-9 | Eduka autentimisvastuse `Assertion` element peab olema krüpteeritud |  Sissetuleva kontrollitud SAML vastuse sisu peab sisaldama täpselt ühte krüpteeritud `Assertion` elementi (`EncryptedAssertion` kujul) **400 Bad Request**. |
| AV-10 | `Assertion` sisu eIDAS spetsiifilised kitsendused | Eduka autentimisvastuse sisu dekrüpteeritud osa peab sisaldama täpselt ühte eksemplari elementidest `<saml2:Assertion>`, `<saml2:AuthnStatement>`, `<saml2:AttributeStatement>`, `<saml2:Subject>` ja `<saml2:AuthnContext>`. Vastasel juhul tuleb tagastada viga **400 Bad Request**. |
| AV-11 | Eduka autentimisvastuse SAML `Assertion` peab olema allkirjastatud  | Eduka autentimise puhul peab SAML `Assertion` olema allkirjastatud. Juhul kui allkiri puudub, peab tagastama vea **400 Bad Request**. |
| AV-12 | Ebaeduka autentimisvastuse SAML `Assertion` võib olla allkirjastatud  | Ebaeduka autentimise puhul võib SAML `Assertion` olla allkirjastatud (aga ei pea).
| AV-13 | SAML `Assertion` väljastamisaja kontroll | Autentimise tulemuse väljastamise aeg (`saml2:Assertion/@IssueInstant`) ei tohi olla tulevikus ega aegunud võttes arvesse serveri kellade erinevust ning maksimaalset lubatud sõnumi eluiga. Väljastamise aeg peab mahtuma vahemikku, mille alguseks on `saml2:Assertion/@IssueInstant` - lubatud interval - lubatud kella erinevus ja `saml2:Assertion/@IssueInstant` + lubatud intervall + lubatud kella erinevus. Muul juhul peab tagastama vea **400 Bad Request**. |
| AV-14 | SAML `Assertion` allkirja kontroll | Kui SAML vastuses on `Assertion` element allkirjastatud peab selle kehtivust valideerima, kasutades konnektorteenuse metateabes publitseeritud avalikku võtit (KeyDescriptor/@use=signing). Juhul kui autentimisvastuse allkiri ei valideeru, peab tagastama vea **400 Bad Request**. |
| AV-15 | SAML `Assertion/Issuer` kontroll | `saml2:Assertion/Issuer/@Format` atribuut peab alati olema `urn:oasis:names:tc:SAML:2.0:nameid-format:entity` ja elemendi sisu vastama konnektorteenuse metadata urlile. Juhul kui autentimisvastus tingimustele ei vasta, peab tagastama vea **400 Bad Request**.|
| AV-16 | SAML `Assertion/Subject` kontrollid - lubatud nimekuju | SAML vastuses peab olema alati täpselt üks `saml2:Assertion/saml2:Subject/saml2:NameID` element ja formaat peab olema üks järgmistest väärtustest: `urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified`, `urn:oasis:names:tc:SAML:2.0:nameid-format:transient` või `urn:oasis:names:tc:SAML:2.0:nameid-format:persistent`. Tingimustele mittevastamise korral peab tagastama vea **400 Bad Request**.</p>|
| AV-17 | SAML `Assertion/Subject` kontrollid - lubatud meetod | SAML vastuses peab olema alati täpselt üks `saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation` element ja selle `@Method` atribuudina on toetatud ainult `urn:oasis:names:tc:SAML:2.0:cm:bearer` meetod. Tingimustele mittevastamise korral peab tagastama vea **400 Bad Request**.</p>|
| AV-18 | SAML `Assertion/Subject` kontrollid - aegumise kontroll |  `/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@NotOnOrAfter` väärtus ei tohi olla suurem kui praegune hetk + lubatud kellaerinevus + max vastuse eluiga. Muul juhul peab tagastama vea **400 Bad Request**. |
| AV-19 | SAML `Assertion/Subject` kontrollid - adressaadi kontroll |  `/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@Recipient` väärtus peab olema sama konfiguratsioonis seadistatud sõnumi vastuvõtupunktiga. Muul juhul peab tagastama vea **400 Bad Request**. |
| AV-20 | SAML `Assertion/Subject` kontrollid - InResponseTo kontroll |  `/saml2p:Response/saml2:Assertion/saml2:Subject/saml2:SubjectConfirmation/saml2:SubjectConfirmationData/@InResponseTo` väärtusele peab leiduma sõnumi vastavustabeli saadetud päringu kirje. Muul juhul peab tagastama vea **400 Bad Request**. |
| AV-21 | SAML `Assertion/Conditions` toetatud kitsendused | <p>SAML vastuses peab olema alati täpselt üks `saml2:Assertion/saml2:Conditions` element ja selle alamelementidest peab olema toetatud ainult `AudienceRestriction`. Muul juhul tuleb tagastada viga **400 Bad Request**. |
| AV-22 | SAML `Assertion/Conditions` kehtivuse kontroll | SAML vastuses olev `saml2:Assertion/saml2:Conditions` elemendi atribuutide `NotBefore` ja `NotOnOrAfter` väärtust tuleb kontrollida. Käesolev hetk ei tohi olla väiksem kui `NotBefore` väärtus ja suurem kui `NotOnOrAfter` väärtus. Tingimustele mittevastamise korral peab tagastama vea **400 Bad Request**.</p>|
| AV-23 | SAML `Assertion/Conditions` kitsenduste töötlus | SAML vastuses olev `saml2:Assertion/saml2:Conditions/saml2:AudienceRestriction` peab sisaldama vähemalt ühte Audience kirjet. Peab leiduma vähemalt üks Audience element, mille sisuks on eidas kliendi metateabe otspunkti aadress. Tingimustele mittevastamise korral peab tagastama vea **400 Bad Request**. |
| AV-24 | SAML `Assertion` `AuthnStatement` kontrollid | <p>SAML vastuses peab olema alati täpselt üks `/saml2:Assertion/saml2:AuthnStatement` element ja eduka autentimise korral peab sisaldama AuthnContext/AuthnContextClassRef elementi, mille sisu peab vastama samaväärsele või kõrgemale LoA-le, kui Loa, mida algses päringus küsiti. Tingimustele mittevastamise korral peab tagastama vea **400 Bad Request**.|
| AV-25 | SAML `Assertion` `AuthnStatement` kontrollid - `AuthnInstant` kehtivuse kontroll|  `/saml2:Assertion/saml2:AuthnStatement/@AuthnInstant` atribuudi väärtus ei tohi olla aegunud (serveri kellade erinevust ja aegumisaega) ega ka tulevikus. Tingimustele mittevastamise korral peab tagastama vea **400 Bad Request**.|
| AV-26 | Käsitlemata vead | Kõik nõuetes käsitlemata vead tuleb kinni püüda ning kasutajale tagastada vastus **500 Internal Server Error**. |
| AV-27 | Kohustuslike atribuutide olemasolu vastuses | SAML autentimisvastus peab sisaldama kõiki päringus kirjeldatud kohustuslikke attribuute. Puudumise korral tagastatakse viga **400 Bad Request**. |
| AV-28 | Edukas autentimine | Kontrollide läbimisel ning eduka autentimisvastuse korral moodustatakse JSON vastus vastavalt [**API kirjelduses**](Service-API.md#returnUrl) toodud kirjeldusele. |